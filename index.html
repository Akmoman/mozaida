<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>موقع مزاد أوقاف المساجد - جلبة الشيع</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- html2pdf for Arabic PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@100;400;700;900&display=swap');
        
        body { font-family: 'Noto Sans Arabic', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f5f5f4; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a29e; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        #report-template { display: none; padding: 20px; background: white; direction: rtl; }
        .report-header { text-align: center; border-bottom: 2px solid #065f46; margin-bottom: 20px; padding-bottom: 10px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .report-table th, .report-table td { border: 1px solid #d1d5db; padding: 10px; text-align: center; font-size: 12px; }
        .report-table th { background-color: #f3f4f6; color: #065f46; font-weight: bold; }

        .countdown-box {
            background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
            color: white;
            padding: 15px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen bg-stone-100 text-stone-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-green-50 z-50 flex items-center justify-center">
        <div class="flex flex-col items-center gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-700"></div>
            <p id="loading-text" class="text-emerald-800 font-bold">جاري الاتصال بقاعدة البيانات...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-emerald-800 text-white p-4 shadow-md sticky top-0 z-40 border-b border-emerald-900">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="ph ph-gavel text-2xl"></i>
                <h1 class="text-xl font-bold tracking-tight">لجنة أوقاف المساجد - بلدة منال</h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="user-info-badge" class="hidden items-center gap-2 text-sm bg-emerald-900/50 pl-1 pr-3 py-1 rounded-full border border-white/10">
                    <i class="ph ph-user text-base"></i>
                    <span id="header-user-name"></span>
                    <span id="header-role-badge" class="hidden bg-amber-500 text-black px-2 py-0.5 rounded text-[10px] font-black mr-1 uppercase"></span>
                    <button id="btn-user-logout" class="mr-3 text-emerald-200 hover:text-white flex items-center gap-1 bg-emerald-900/40 px-2 py-1 rounded-lg transition-colors" title="تسجيل الخروج">
                        <i class="ph ph-sign-out text-base"></i> خروج
                    </button>
                </div>
                <button id="btn-show-admin-login" class="p-1.5 bg-emerald-700 hover:bg-emerald-600 rounded-full transition-colors text-emerald-100 hover:text-white hidden border border-emerald-600/50" title="دخول الإدارة">
                    <i class="ph ph-lock text-base"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 py-8 space-y-6">
        
        <!-- Admin/Committee Controls -->
        <div id="admin-dashboard" class="hidden bg-stone-900 text-white rounded-2xl shadow-xl overflow-hidden border border-stone-700">
            <div class="p-4 border-b border-stone-700 flex justify-between items-center bg-stone-800">
                <h2 id="dashboard-title" class="font-bold flex items-center gap-2 text-emerald-400"><i class="ph ph-gear text-xl"></i> لوحة التحكم</h2>
                <div class="flex gap-2">
                    <button id="btn-exit-admin" class="px-3 py-1.5 rounded-lg text-xs font-bold bg-stone-700 hover:bg-stone-600 text-white flex items-center gap-1 transition-all">
                        <i class="ph ph-house"></i> الرئيسية
                    </button>
                </div>
            </div>
            <div class="flex bg-stone-800 flex-wrap" id="dashboard-tabs-container">
                <button id="tab-bids" class="flex-1 min-w-[120px] p-3 font-bold transition-colors">سجل المزايدات</button>
                <button id="tab-users" class="flex-1 min-w-[120px] p-3 font-bold transition-colors">الأعضاء</button>
                <button id="tab-settings" class="flex-1 min-w-[120px] p-3 font-bold transition-colors">إعدادات المزاد</button>
                <button id="tab-add-manual" class="flex-1 min-w-[120px] p-3 font-bold transition-colors">إضافة يدوية</button>
            </div>
            
            <div class="p-4 bg-stone-50 max-h-[500px] overflow-y-auto text-stone-800 custom-scrollbar">
                <!-- Admin Bids List -->
                <div id="admin-bids-list" class="space-y-3"></div>
                <!-- Admin Users List -->
                <div id="admin-users-list" class="space-y-3 hidden"></div>
                <!-- Auction Settings Form -->
                <div id="admin-auction-settings" class="hidden max-w-md mx-auto py-4 space-y-6">
                    <div class="bg-white p-4 rounded-xl border-2 border-stone-100 space-y-4 text-right">
                        <h3 class="font-bold text-emerald-800 border-b pb-2 flex items-center gap-2 justify-end">
                            إعداد التوقيت والحد الأدنى <i class="ph ph-clock"></i>
                        </h3>
                        <div>
                            <label class="block text-xs font-bold text-stone-500 mb-1">الحد الأدنى للمزايدة (سعر البداية)</label>
                            <input type="number" id="setting-min-bid" class="w-full border-2 border-stone-200 rounded-xl p-2 text-right" placeholder="مثال: 50" />
                        </div>
                        <div class="grid grid-cols-3 gap-2" dir="ltr">
                            <div>
                                <label class="block text-[10px] font-bold text-stone-400 text-center">أيام</label>
                                <input type="number" id="timer-days" class="w-full border-2 border-stone-200 rounded-xl p-2 text-center" value="0" />
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-stone-400 text-center">ساعات</label>
                                <input type="number" id="timer-hours" class="w-full border-2 border-stone-200 rounded-xl p-2 text-center" value="0" />
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-stone-400 text-center">دقائق</label>
                                <input type="number" id="timer-mins" class="w-full border-2 border-stone-200 rounded-xl p-2 text-center" value="0" />
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="btn-save-settings" class="flex-1 bg-emerald-600 text-white font-bold py-2 rounded-xl text-sm transition-all hover:bg-emerald-700">تطبيق الإعدادات وتشغيل الوقت</button>
                            <button id="btn-stop-timer" class="bg-red-500 text-white font-bold px-4 py-2 rounded-xl text-sm transition-all hover:bg-red-600">إيقاف الوقت</button>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl border-2 border-stone-100">
                        <button id="btn-toggle-auction" class="w-full py-3 rounded-xl font-black text-sm transition-all shadow-md">
                            <!-- Dynamic Text -->
                        </button>
                    </div>
                </div>
                <!-- Manual Add Form -->
                <div id="admin-manual-form" class="hidden max-w-md mx-auto py-4 text-right">
                    <h3 class="font-bold mb-4 flex items-center gap-2 text-emerald-800 border-b pb-2 justify-end">إضافة عضو/لجنة بشكل يدوي <i class="ph ph-user-plus"></i></h3>
                    <form id="form-manual-add" class="space-y-3">
                        <input type="text" id="manual-name" placeholder="الاسم الكامل" required class="w-full border-2 border-stone-200 rounded-xl p-3 outline-none focus:border-emerald-500 transition-all text-right" />
                        <input type="tel" id="manual-phone" placeholder="رقم الهاتف (9xxxxxxx)" required class="w-full border-2 border-stone-200 rounded-xl p-3 outline-none focus:border-emerald-500 transition-all text-right" dir="ltr" />
                        <input type="text" id="manual-pass" placeholder="الرقم السري المقترح" required class="w-full border-2 border-stone-200 rounded-xl p-3 outline-none focus:border-emerald-500 transition-all text-right" />
                        <div class="flex items-center gap-2 py-2 justify-end">
                            <label for="manual-is-committee" class="text-sm font-bold text-stone-700">تعيين كعضو في "لجنة الأوقاف"</label>
                            <input type="checkbox" id="manual-is-committee" class="w-5 h-5 accent-emerald-600" />
                        </div>
                        <button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-emerald-700 transition-all">حفظ وتفعيل الحساب</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Countdown Timer Card -->
        <div id="countdown-container" class="hidden animate-fade-in">
            <div class="countdown-box border-b-4 border-emerald-900">
                <p class="text-[10px] font-bold uppercase tracking-widest opacity-70 mb-1">الوقت المتبقي لانتهاء المزاد</p>
                <div class="flex justify-center items-center gap-4 text-2xl font-black tabular-nums" dir="ltr">
                    <div class="flex flex-col items-center"><span id="cd-days">00</span><span class="text-[9px] font-normal opacity-60">D</span></div>
                    <span class="opacity-30">:</span>
                    <div class="flex flex-col items-center"><span id="cd-hours">00</span><span class="text-[9px] font-normal opacity-60">H</span></div>
                    <span class="opacity-30">:</span>
                    <div class="flex flex-col items-center"><span id="cd-mins">00</span><span class="text-[9px] font-normal opacity-60">M</span></div>
                    <span class="opacity-30">:</span>
                    <div class="flex flex-col items-center"><span id="cd-secs">00</span><span class="text-[9px] font-normal opacity-60">S</span></div>
                </div>
            </div>
        </div>

        <!-- Farm Info Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden">
            <div class="bg-emerald-50 border-b border-emerald-100 p-6 text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="ph ph-leaf text-9xl"></i></div>
                <h2 class="text-3xl font-extrabold text-emerald-900 mb-2 relative z-10">إعلان تأجير مزرعة (أوقاف المساجد)</h2>
                <div class="inline-block bg-emerald-600 text-white px-6 py-1.5 rounded-full font-bold text-lg shadow-sm relative z-10">
                    اسم الوقف: جلبة الشيع
                </div>
            </div>
            <div class="w-full border-b border-stone-100 bg-stone-50 flex justify-center p-4">
                <img src="https://storage.googleapis.com/akm1983/%D8%A7%D9%95%D8%B9%D9%84%D8%A7%D9%86%20%D8%AA%D8%A7%D9%94%D8%AC%D9%8A%D8%B1%20%D9%85%D8%B2%D8%B1%D8%B9%D8%A9%20(%D8%A7%D9%94%D9%88%D9%82%D8%A7%D9%81%20%D8%A7%D9%84%D9%85%D8%B3%D8%A7%D8%AC%D8%AF).png" alt="إعلان المزرعة" class="max-h-[400px] w-auto object-contain rounded-xl shadow-sm border border-stone-200" onerror="this.style.display='none';" />
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8 text-sm">
                <div class="space-y-3 text-right">
                    <h3 class="text-lg font-bold border-b-2 border-emerald-500 pb-2 mb-4 inline-block text-emerald-900">تفاصيل المزرعة</h3>
                    <ul class="space-y-2">
                        <li class="flex items-center gap-3"><i class="ph ph-map-pin text-emerald-600"></i> <span class="font-bold">المكان:</span> بلدة منال</li>
                        <li class="flex items-center gap-3"><i class="ph ph-clock text-emerald-600"></i> <span class="font-bold">ساعات الماء:</span> ساعتين</li>
                        <li class="flex items-center gap-3"><i class="ph ph-tree-palm text-emerald-600"></i> <span class="font-bold">عدد النخيل:</span> 12 نخلة</li>
                        <li class="flex items-center gap-3"><i class="ph ph-calendar text-emerald-600"></i> <span class="font-bold">مدة العقد:</span> 10 سنوات</li>
                    </ul>
                </div>
                <div class="bg-emerald-50/50 p-4 rounded-xl border border-emerald-100">
                    <p class="font-bold text-sm text-emerald-800 leading-relaxed italic text-right">"يتحمل المزايد المسؤولية القانونية والمالية في حال رسو المزايدة عليه وفق القوانين والأنظمة المعمول بها والالتزام بعقد التأجير."</p>
                </div>
            </div>
        </div>

        <!-- Bidding Section -->
        <div class="bg-white rounded-2xl shadow-xl border border-stone-200 overflow-hidden">
            <div class="p-8 bg-stone-50 flex flex-col items-center justify-center border-b border-stone-200 text-center">
                <p class="text-stone-500 font-bold mb-1 tracking-widest uppercase text-xs">أعلى سعر معروض حالياً</p>
                <div class="text-6xl font-black text-emerald-800 flex items-baseline gap-2">
                    <span id="highest-bid-display" class="tabular-nums">0</span> <span class="text-2xl text-stone-400 font-medium tracking-normal">ريال</span>
                </div>
                <div id="auction-closed-msg" class="hidden mt-4 bg-red-600 text-white px-8 py-2 rounded-2xl font-black text-lg shadow-xl animate-pulse">تم إغلاق المزاد وتمت الترسية</div>
            </div>

            <div class="p-6 border-b border-stone-100 bg-white">
                <!-- Login View -->
                <div id="section-login" class="max-w-md mx-auto hidden space-y-6 text-center">
                    <i class="ph ph-sign-in text-4xl text-emerald-700 mb-2 block"></i>
                    <h2 class="text-xl font-black text-stone-800">تسجيل الدخول للمزايدة</h2>
                    <form id="form-login" class="space-y-4">
                        <input type="tel" id="login-phone" required class="w-full border-2 border-stone-100 rounded-2xl p-4 outline-none focus:border-emerald-500 transition-all text-lg font-bold text-right" placeholder="رقم الهاتف (9xxxxxxx)" dir="ltr" />
                        <input type="password" id="login-password" required class="w-full border-2 border-stone-100 rounded-2xl p-4 outline-none focus:border-emerald-500 transition-all text-lg text-center tracking-[1em]" placeholder="••••" dir="ltr" />
                        <p id="login-error" class="text-red-500 text-xs font-bold hidden text-center bg-red-50 p-2 rounded-lg"></p>
                        <button type="submit" class="w-full bg-stone-800 hover:bg-black text-white font-black py-4 rounded-2xl shadow-xl transition-all active:scale-95">دخول للمزايدة</button>
                    </form>
                    <button id="btn-show-register" class="w-full mt-4 text-sm font-bold text-emerald-700 hover:bg-emerald-50 py-3 rounded-xl transition-all">ليس لديك حساب؟ الحصول على العضوية</button>
                </div>
                
                <!-- Register View -->
                <div id="section-register" class="max-w-md mx-auto hidden space-y-6 text-center">
                    <i class="ph ph-user-plus text-4xl text-emerald-700 mb-2 block"></i>
                    <h2 class="text-xl font-black text-stone-800">طلب فتح عضوية جديدة</h2>
                    <form id="form-register" class="space-y-4 text-right">
                        <input type="text" id="reg-name" required class="w-full border-2 border-stone-100 rounded-2xl p-4 outline-none focus:border-emerald-500 transition-all text-right" placeholder="الاسم الثلاثي والقبيلة" />
                        <input type="tel" id="reg-phone" required class="w-full border-2 border-stone-100 rounded-2xl p-4 outline-none focus:border-emerald-500 transition-all text-right" placeholder="رقم الهاتف (9xxxxxxx)" dir="ltr" />
                        <p id="reg-error" class="text-red-500 text-xs font-bold hidden text-center bg-red-50 p-2 rounded-lg"></p>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-black py-4 rounded-2xl shadow-xl transition-all">إرسال الطلب</button>
                    </form>
                    <button id="btn-show-login" class="w-full text-xs font-bold text-stone-500 hover:text-stone-800 transition-all py-2 text-center">لديك بيانات دخول؟ تسجيل الدخول</button>
                </div>

                <!-- Pending View -->
                <div id="section-pending" class="hidden">
                    <div class="bg-amber-50 p-8 rounded-[40px] border-2 border-amber-200 text-center max-w-md mx-auto shadow-xl">
                        <i class="ph ph-clock-countdown text-5xl text-amber-500 mb-4 block animate-pulse"></i>
                        <h3 class="text-xl font-black text-amber-900 mb-2">طلبك قيد المراجعة</h3>
                        <p class="text-amber-800 text-sm mb-6 leading-relaxed">ستقوم الإدارة بمراجعة طلبك وتزويدك برقم سري عبر الواتساب فور التفعيل.</p>
                        <div class="flex flex-col gap-3 pt-4 border-t border-amber-200">
                            <button id="btn-pending-to-login" class="text-sm font-black text-amber-700 underline underline-offset-4">شاشة دخول الأعضاء</button>
                            <button id="btn-cancel-reg" class="text-xs font-bold text-stone-400 py-2">تسجيل عضو جديد (طلب آخر)</button>
                        </div>
                    </div>
                </div>

                <!-- Bidding View -->
                <div id="section-bidding" class="hidden max-w-md mx-auto space-y-6">
                    <div class="flex items-center justify-between bg-white rounded-3xl border-4 border-emerald-100 p-2 shadow-inner">
                        <button id="btn-decrease-bid" class="bg-stone-100 h-16 w-16 rounded-2xl text-3xl font-black transition-all">-</button>
                        <div class="text-center flex-1">
                            <span id="current-bid-input-display" class="text-5xl font-black text-emerald-900 tabular-nums">0</span>
                            <span class="block text-[10px] font-bold text-stone-400 mt-1 uppercase tracking-wider">ر.ع</span>
                        </div>
                        <button id="btn-increase-bid" class="bg-emerald-600 text-white h-16 w-16 rounded-2xl text-3xl font-black transition-all shadow-lg hover:bg-emerald-700">+</button>
                    </div>
                    <form id="form-bid">
                        <p id="bid-error" class="text-red-500 text-xs font-bold text-center mb-2 hidden bg-red-50 p-2 rounded"></p>
                        <button type="submit" class="w-full bg-emerald-700 hover:bg-emerald-800 text-white font-black py-5 rounded-3xl shadow-2xl transition-all transform active:scale-[0.98] text-xl">تأكيد المزايدة بـ (<span id="btn-submit-bid-amount" class="tabular-nums">0</span> ريال)</button>
                    </form>
                </div>
            </div>

            <!-- History List -->
            <div class="p-8 bg-stone-50/30">
                <h3 class="font-black text-stone-700 mb-6 flex items-center gap-3 text-lg border-r-4 border-stone-300 pr-4 justify-end">
                    سجل المزايدات الأخير <i class="ph ph-clock-counter-clockwise text-2xl"></i>
                </h3>
                <div id="public-bids-list" class="space-y-3"></div>
            </div>
        </div>

    </main>

    <!-- Report Template (Hidden) -->
    <div id="report-template">
        <div class="report-header">
            <h1 style="font-size: 24px; font-weight: bold; color: #065f46; margin-bottom: 5px;">تقرير مزاد أوقاف المساجد</h1>
            <p style="font-size: 16px;">اسم الوقف: جلبة الشيع</p>
            <p id="report-date" style="font-size: 14px; margin-top: 5px;"></p>
        </div>
        <table class="report-table">
            <thead>
                <tr>
                    <th>م</th>
                    <th>اسم المزايد</th>
                    <th>رقم الهاتف</th>
                    <th>المبلغ (ريال)</th>
                    <th>التاريخ والوقت</th>
                </tr>
            </thead>
            <tbody id="report-table-body"></tbody>
        </table>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-black/80 items-center justify-center z-[70] p-4 backdrop-blur-md hidden">
        <div class="bg-white rounded-[40px] shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in border border-white/20">
            <div class="bg-stone-900 p-6 text-white flex justify-between items-center">
                <h3 class="font-black text-xl flex items-center gap-3"><i class="ph ph-lock-laminated text-2xl"></i> دخول الإدارة</h3>
                <button id="btn-close-admin-modal" class="text-stone-400 hover:text-white transition-colors"><i class="ph ph-x-circle text-3xl"></i></button>
            </div>
            <form id="form-admin-login" class="p-8 space-y-6 text-right">
                <input type="password" id="admin-password" class="w-full border-2 border-stone-200 rounded-2xl p-5 focus:ring-0 focus:border-stone-900 outline-none text-center text-3xl tracking-[0.5em] font-black transition-all bg-stone-50" placeholder="••••" dir="ltr" />
                <p id="admin-login-error" class="text-red-600 text-xs font-bold text-center hidden bg-red-50 p-2 rounded"></p>
                <button type="submit" class="w-full bg-stone-900 hover:bg-black text-white font-black py-4 rounded-2xl shadow-xl transition-all">دخول</button>
            </form>
        </div>
    </div>

    <!-- Application Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, updateDoc, serverTimestamp, deleteDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAffSkbM4yXDON0ASVwRCr165_Gu_yGPF4",
            authDomain: "aldhahir-stadium.firebaseapp.com",
            projectId: "aldhahir-stadium",
            storageBucket: "aldhahir-stadium.firebasestorage.app",
            messagingSenderId: "561631723946",
            appId: "1:561631723946:web:d17f9e8a95ed860b856bd3"
        };
        const appId = "aldhahir-stadium";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let appProfile = null;
        let bids = [];
        let usersList = [];
        let auctionSettings = { isActive: true, startingPrice: 50 };
        let currentBidAmount = 5;
        let adminTab = 'tab-bids'; 
        let currentAuthView = localStorage.getItem('auth_view_preference') || 'login'; 
        let timerInterval = null;

        // Core Functions
        const showToast = (message) => {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-10 right-10 bg-stone-800 text-white px-8 py-4 rounded-[30px] shadow-2xl z-[100] font-black animate-fade-in flex items-center gap-3 border border-white/10';
            toast.innerHTML = `<i class="ph ph-info text-2xl text-emerald-400"></i> <span>${message}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 5000);
        };

        const formatFullDate = (ts) => {
            if (!ts) return "جاري التسجيل...";
            const date = ts.toDate ? ts.toDate() : new Date(ts);
            return date.toLocaleString('en-US', { 
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit', hour12: true 
            });
        };

        const updateCountdownUI = () => {
            if (!auctionSettings.endTime || auctionSettings.timerPaused) {
                document.getElementById('countdown-container').classList.add('hidden');
                return;
            }
            
            const now = new Date().getTime();
            const distance = auctionSettings.endTime - now;
            
            if (distance < 0) {
                document.getElementById('countdown-container').classList.add('hidden');
                if (auctionSettings.isActive && appProfile?.isAdmin) {
                    updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'auction'), { isActive: false });
                }
                return;
            }

            document.getElementById('countdown-container').classList.remove('hidden');
            const d = Math.floor(distance / (1000 * 60 * 60 * 24));
            const h = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((distance % (1000 * 60)) / 1000);

            document.getElementById('cd-days').textContent = d.toString().padStart(2, '0');
            document.getElementById('cd-hours').textContent = h.toString().padStart(2, '0');
            document.getElementById('cd-mins').textContent = m.toString().padStart(2, '0');
            document.getElementById('cd-secs').textContent = s.toString().padStart(2, '0');
        };

        const updateUIVisibility = () => {
            const isAuth = localStorage.getItem('is_authenticated') === 'true';
            const userBadge = document.getElementById('user-info-badge');
            const adminLoginBtn = document.getElementById('btn-show-admin-login');
            
            const isAdmin = appProfile?.isAdmin;
            const isCommittee = appProfile?.isCommittee;

            if (appProfile && (isAdmin || isCommittee || (appProfile.isActive && isAuth))) {
                userBadge.classList.replace('hidden', 'flex');
                document.getElementById('header-user-name').textContent = appProfile.name;
                const badge = document.getElementById('header-role-badge');
                if (isAdmin) { badge.textContent = 'إدارة'; badge.classList.remove('hidden'); }
                else if (isCommittee) { badge.textContent = 'لجنة الأوقاف'; badge.classList.remove('hidden'); }
                else { badge.classList.add('hidden'); }
                adminLoginBtn.classList.add('hidden');
            } else {
                userBadge.classList.replace('flex', 'hidden');
                adminLoginBtn.classList.remove('hidden');
            }

            document.getElementById('section-login').classList.add('hidden');
            document.getElementById('section-register').classList.add('hidden');
            document.getElementById('section-pending').classList.add('hidden');
            document.getElementById('section-bidding').classList.add('hidden');
            document.getElementById('auction-closed-msg').classList.add('hidden');

            if (!auctionSettings.isActive) {
                document.getElementById('auction-closed-msg').classList.remove('hidden');
            } else {
                if (!appProfile) {
                    currentAuthView === 'login' ? document.getElementById('section-login').classList.remove('hidden') : document.getElementById('section-register').classList.remove('hidden');
                } else if (isAdmin) {
                    // Admin view
                } else if (isCommittee || (appProfile.isActive && isAuth)) {
                    document.getElementById('section-bidding').classList.remove('hidden');
                } else {
                    currentAuthView === 'login' ? document.getElementById('section-login').classList.remove('hidden') : document.getElementById('section-pending').classList.remove('hidden');
                }
            }

            document.getElementById('admin-dashboard').classList.toggle('hidden', !isAdmin && !isCommittee);
            if (isAdmin || isCommittee) renderAdminPanel();
        };

        const setupListeners = (uid) => {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), (snap) => {
                appProfile = snap.exists() ? snap.data() : null;
                updateUIVisibility();
                document.getElementById('loading-overlay').style.display = 'none';
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'bids'), (snap) => {
                bids = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.amount - a.amount);
                const high = bids.length > 0 ? bids[0].amount : (auctionSettings.startingPrice || 0);
                document.getElementById('highest-bid-display').textContent = high.toLocaleString('en-US');
                if (currentBidAmount < high + 5) { currentBidAmount = high + 5; updateBidUI(); }
                renderPublicBids();
            });

            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'auction'), (snap) => {
                auctionSettings = snap.exists() ? snap.data() : { isActive: true, startingPrice: 50 };
                document.getElementById('setting-min-bid').value = auctionSettings.startingPrice || 50;
                updateUIVisibility();
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateCountdownUI, 1000);
                updateCountdownUI();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                usersList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAdminPanel();
            });
        };

        (async function init() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        const localUid = localStorage.getItem('guest_auction_uid') || user.uid;
                        setupListeners(localUid);
                    } else {
                        document.getElementById('loading-overlay').style.display = 'none';
                    }
                });
            } catch (err) {
                document.getElementById('loading-text').innerHTML = `<span class="text-red-500">خطأ في الاتصال</span>`;
            }
        })();

        const renderPublicBids = () => {
            const list = document.getElementById('public-bids-list');
            if (bids.length === 0) {
                list.innerHTML = `<div class="p-8 text-center text-stone-400 font-bold border-2 border-dashed rounded-3xl border-stone-200">بانتظار المزايدة الأولى. السعر الافتتاحي: ${auctionSettings.startingPrice} ريال</div>`;
                return;
            }
            const canSeeNames = appProfile?.isAdmin || appProfile?.isCommittee;
            list.innerHTML = bids.slice(0, 10).map((b, i) => `
                <div class="flex justify-between items-center p-5 bg-white rounded-2xl border ${i === 0 ? 'border-emerald-200 ring-4 ring-emerald-500/10 scale-[1.02]' : 'border-stone-100'} shadow-sm animate-fade-in">
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-full flex items-center justify-center ${i === 0 ? 'bg-emerald-600 text-white' : 'bg-stone-100 text-stone-400'}">
                            <i class="ph ph-${i === 0 ? 'trophy' : 'user'}"></i>
                        </div>
                        <span class="font-black text-stone-700">${canSeeNames ? b.name : (localStorage.getItem('guest_auction_uid') === b.userId ? 'أنت (مزايدتك)' : 'مزايد مخفي')}</span>
                    </div>
                    <span class="text-2xl font-black text-emerald-800 tabular-nums">${b.amount.toLocaleString('en-US')} <small class="text-xs font-normal opacity-50 mr-1">ريال</small></span>
                </div>
            `).join('');
        };

        const updateBidUI = () => {
            document.getElementById('current-bid-input-display').textContent = currentBidAmount.toLocaleString('en-US');
            document.getElementById('btn-submit-bid-amount').textContent = currentBidAmount.toLocaleString('en-US');
            const high = bids.length > 0 ? bids[0].amount : (auctionSettings.startingPrice || 0);
            document.getElementById('btn-decrease-bid').style.opacity = currentBidAmount <= high + 5 ? '0.2' : '1';
        };

        const renderAdminPanel = () => {
            const isAdmin = appProfile?.isAdmin;
            const isCommittee = appProfile?.isCommittee;
            if (!isAdmin && !isCommittee) return;

            const toggleBtn = document.getElementById('btn-toggle-auction');
            toggleBtn.innerHTML = auctionSettings.isActive ? '<i class="ph ph-lock-key"></i> إغلاق المزاد' : '<i class="ph ph-lock-key-open"></i> فتح المزاد';
            toggleBtn.className = `w-full py-3 rounded-xl font-black shadow-lg transition-all ${auctionSettings.isActive ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-emerald-600 hover:bg-emerald-700 text-white'}`;

            ['tab-bids', 'tab-users', 'tab-add-manual', 'tab-settings'].forEach(t => document.getElementById(t)?.classList.remove('bg-emerald-600', 'text-white'));
            ['admin-bids-list', 'admin-users-list', 'admin-manual-form', 'admin-auction-settings'].forEach(c => document.getElementById(c)?.classList.add('hidden'));

            if (isCommittee && !isAdmin) {
                document.getElementById('tab-users').classList.add('hidden');
                document.getElementById('tab-settings').classList.add('hidden');
                document.getElementById('tab-add-manual').classList.add('hidden');
                if (adminTab !== 'tab-bids') adminTab = 'tab-bids';
            } else {
                document.getElementById('tab-users').classList.remove('hidden');
                document.getElementById('tab-settings').classList.remove('hidden');
                document.getElementById('tab-add-manual').classList.remove('hidden');
            }

            document.getElementById(adminTab).classList.add('bg-emerald-600', 'text-white');
            
            if (adminTab === 'tab-bids') {
                document.getElementById('admin-bids-list').classList.remove('hidden');
                document.getElementById('admin-bids-list').innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <button onclick="window.downloadPDF()" class="bg-emerald-100 text-emerald-800 px-4 py-2 rounded-xl text-xs font-black flex items-center gap-2 border border-emerald-200 hover:bg-emerald-200 transition-colors"><i class="ph ph-file-pdf text-lg"></i> تحميل تقرير PDF</button>
                        ${isAdmin ? `<button onclick="window.clearAllBids()" class="bg-red-50 text-red-700 px-4 py-2 rounded-xl text-xs font-black border border-red-100">تصفير المزاد</button>` : ''}
                    </div>
                    ${bids.map(b => `
                        <div class="flex justify-between items-center p-3 bg-white rounded-xl border mb-2 shadow-sm">
                            <div class="text-right">
                                <p class="font-black text-sm">${b.name}</p>
                                <p class="text-[10px] text-stone-400 font-bold">${b.phone} - ${formatFullDate(b.timestamp)}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-black text-emerald-700 text-lg">${b.amount.toLocaleString('en-US')} ريال</span>
                                ${isAdmin ? `<button onclick="window.deleteBid('${b.id}')" class="text-red-400 hover:text-red-600 p-2"><i class="ph ph-trash-simple text-xl"></i></button>` : ''}
                            </div>
                        </div>
                    `).join('')}`;
            } else if (adminTab === 'tab-users') {
                if (!isAdmin) return;
                document.getElementById('admin-users-list').classList.remove('hidden');
                const normal = usersList.filter(u => !u.isAdmin);
                document.getElementById('admin-users-list').innerHTML = normal.map(u => `
                    <div class="flex justify-between items-center p-4 bg-white rounded-xl border mb-2 shadow-sm text-right">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 justify-end">
                                ${u.isCommittee ? '<span class="bg-blue-100 text-blue-800 text-[9px] px-1.5 py-0.5 rounded font-black">عضو لجنة</span>' : ''}
                                <p class="font-black text-stone-800">${u.name}</p>
                            </div>
                            <p class="text-xs font-bold text-stone-400 tracking-wider">${u.phone}</p>
                            ${u.password ? `<p class="text-xs font-black text-blue-600 mt-1 bg-blue-50 px-2 py-0.5 rounded w-fit mr-auto">سر: ${u.password}</p>` : ''}
                        </div>
                        <div class="flex flex-wrap gap-2 items-center justify-end ml-4">
                            ${!u.isActive 
                                ? `<button onclick="window.activateUser('${u.id}')" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black shadow-md">تفعيل</button>`
                                : `<div class="flex gap-1">
                                     <button onclick="window.updatePassword('${u.id}')" class="bg-blue-50 text-blue-600 p-2 rounded-lg border border-blue-100"><i class="ph ph-key"></i></button>
                                     <button onclick="window.toggleCommittee('${u.id}', ${u.isCommittee})" class="p-2 rounded-lg border ${u.isCommittee ? 'bg-amber-100 text-amber-700' : 'bg-stone-50'}">${u.isCommittee ? '<i class="ph ph-user-minus"></i>' : '<i class="ph ph-users-three"></i>'}</button>
                                     <button onclick="window.sendWhatsApp('${u.phone}', '${u.name}', '${u.password}')" class="bg-green-500 text-white p-2 rounded-lg"><i class="ph ph-whatsapp-logo text-xl"></i></button>
                                   </div>`}
                            <button onclick="window.deleteUser('${u.id}')" class="text-stone-300 hover:text-red-500 p-2"><i class="ph ph-trash text-xl"></i></button>
                        </div>
                    </div>
                `).join('');
            } else if (adminTab === 'tab-settings') {
                if (!isAdmin) return;
                document.getElementById('admin-auction-settings').classList.remove('hidden');
                document.getElementById('btn-stop-timer').textContent = auctionSettings.timerPaused ? 'استئناف الوقت' : 'إيقاف الوقت';
            } else if (adminTab === 'tab-add-manual') {
                if (!isAdmin) return;
                document.getElementById('admin-manual-form').classList.remove('hidden');
            }
        };

        // Handlers
        document.getElementById('btn-show-login').onclick = () => setAuthView('login');
        document.getElementById('btn-show-register').onclick = () => setAuthView('register');
        document.getElementById('btn-pending-to-login').onclick = () => setAuthView('login');
        document.getElementById('btn-cancel-reg').onclick = () => { localStorage.removeItem('guest_auction_uid'); localStorage.setItem('auth_view_preference', 'register'); window.location.reload(); };

        document.getElementById('form-register').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            try {
                const uid = `u-${Date.now()}`;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), { uid, name, phone, isActive: false, isAdmin: false, isCommittee: false, registeredAt: serverTimestamp() });
                localStorage.setItem('guest_auction_uid', uid);
                localStorage.setItem('is_authenticated', 'false');
                setAuthView('pending');
                showToast("تم إرسال طلبك");
            } catch(e) { showToast("خطأ في الاتصال"); }
        };

        document.getElementById('form-login').onsubmit = async (e) => {
            e.preventDefault();
            const phone = document.getElementById('login-phone').value.trim();
            const pass = document.getElementById('login-password').value.trim();
            const err = document.getElementById('login-error');
            err.classList.add('hidden');
            try {
                const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
                let found = null;
                snap.forEach(d => { const data = d.data(); if (data.phone === phone && data.password === pass && !data.isAdmin) found = data; });
                if (found) {
                    if (!found.isActive && !found.isCommittee) { err.textContent = "حسابك غير مفعل."; err.classList.remove('hidden'); }
                    else { localStorage.setItem('guest_auction_uid', found.uid); localStorage.setItem('is_authenticated', 'true'); window.location.reload(); }
                } else { err.textContent = "البيانات غير صحيحة."; err.classList.remove('hidden'); }
            } catch(e) { showToast("فشل الاتصال"); }
        };

        document.getElementById('form-manual-add').onsubmit = async (e) => {
            e.preventDefault();
            const uid = `manual-${Date.now()}`;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', uid), {
                uid, name: document.getElementById('manual-name').value, phone: document.getElementById('manual-phone').value,
                password: document.getElementById('manual-pass').value, isActive: true, isCommittee: document.getElementById('manual-is-committee').checked, isAdmin: false, registeredAt: serverTimestamp()
            });
            showToast("تمت الإضافة بنجاح");
            e.target.reset(); adminTab = 'tab-users'; renderAdminPanel();
        };

        document.getElementById('btn-save-settings').onclick = async () => {
            const d = parseInt(document.getElementById('timer-days').value) || 0;
            const h = parseInt(document.getElementById('timer-hours').value) || 0;
            const m = parseInt(document.getElementById('timer-mins').value) || 0;
            const price = parseInt(document.getElementById('setting-min-bid').value) || 50;
            const totalMs = (d * 24 * 60 * 60 * 1000) + (h * 60 * 60 * 1000) + (m * 60 * 1000);
            const endTime = new Date().getTime() + totalMs;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'auction'), { endTime, timerPaused: false, startingPrice: price, isActive: true });
            showToast("تم التفعيل بنجاح");
        };

        document.getElementById('btn-stop-timer').onclick = async () => {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'auction'), { timerPaused: !auctionSettings.timerPaused });
        };

        document.getElementById('btn-increase-bid').onclick = () => { currentBidAmount += 5; updateBidUI(); };
        document.getElementById('btn-decrease-bid').onclick = () => { 
            const high = bids.length > 0 ? bids[0].amount : (auctionSettings.startingPrice || 0);
            if (currentBidAmount > high + 5) { currentBidAmount -= 5; updateBidUI(); } 
        };
        
        document.getElementById('form-bid').onsubmit = async (e) => {
            e.preventDefault();
            const high = bids.length > 0 ? bids[0].amount : (auctionSettings.startingPrice || 0);
            if (currentBidAmount <= high) return showToast("يجب أن تكون المزايدة أعلى");
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bids'), {
                    amount: currentBidAmount, userId: localStorage.getItem('guest_auction_uid'), name: appProfile.name, phone: appProfile.phone, timestamp: serverTimestamp()
                });
                showToast("تمت المزايدة بنجاح");
            } catch(e) { showToast("خطأ في المزايدة"); }
        };

        document.getElementById('btn-show-admin-login').onclick = () => document.getElementById('admin-login-modal').classList.replace('hidden', 'flex');
        document.getElementById('btn-close-admin-modal').onclick = () => document.getElementById('admin-login-modal').classList.replace('flex', 'hidden');
        document.getElementById('form-admin-login').onsubmit = async (e) => {
            e.preventDefault();
            if (document.getElementById('admin-password').value === 'akm1983') {
                const adminUid = 'admin-akm1983-secure-uid';
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', adminUid), { uid: adminUid, name: 'akm1983', phone: '-', isActive: true, isAdmin: true }, { merge: true });
                localStorage.setItem('guest_auction_uid', adminUid); localStorage.setItem('is_authenticated', 'true');
                window.location.reload();
            } else { document.getElementById('admin-login-error').textContent = "خطأ"; document.getElementById('admin-login-error').classList.remove('hidden'); }
        };

        document.getElementById('btn-user-logout').onclick = () => { localStorage.removeItem('guest_auction_uid'); localStorage.removeItem('is_authenticated'); window.location.reload(); };
        document.getElementById('btn-exit-admin').onclick = () => { localStorage.removeItem('guest_auction_uid'); localStorage.removeItem('is_authenticated'); window.location.reload(); };

        window.activateUser = async (id) => {
            const pwd = prompt("أدخل الرقم السري للعضو:");
            if (!pwd) return;
            const u = usersList.find(x => x.id === id);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), { isActive: true, password: pwd.trim() });
            window.sendWhatsApp(u.phone, u.name, pwd.trim());
        };

        window.updatePassword = async (id) => {
            const pwd = prompt("تغيير الرقم السري:");
            if (!pwd) return;
            const u = usersList.find(x => x.id === id);
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), { password: pwd.trim() });
            showToast("تم التحديث");
            if (confirm("إرسال الجديد للعضو؟")) window.sendWhatsApp(u.phone, u.name, pwd.trim());
        };

        window.toggleCommittee = async (id, current) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), { isCommittee: !current }); };
        window.deleteUser = async (id) => { if (confirm("حذف؟")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id)); };
        window.deleteBid = async (id) => { if (confirm("حذف؟")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bids', id)); };
        window.clearAllBids = async () => { if (confirm("تصفير؟")) { const s = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'bids')); s.forEach(async (d) => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bids', d.id))); } };
        
        window.sendWhatsApp = (phone, name, password) => {
            const clean = phone.replace(/\D/g, '');
            const phoneW = clean.length === 8 ? '968' + clean : clean;
            const msg = `مرحباً بك الفاضل/ ${name}،%0Aتم تفعيل عضويتك في مزاد أوقاف المساجد (جلبة الشيع) بنجاح.%0A%0Aبيانات الدخول:%0Aرقم الهاتف: ${phone}%0Aالرقم السري: ${password}%0A%0Aرابط المزاد المباشر:%0A${window.location.href}%0A%0Aشروط المزايدة:%0Aيقر المزايد بتحمل المسؤولية القانونية والمالية الكاملة في حال رسو المزايدة عليه وفق القوانين والأنظمة المعمول بها والالتزام بعقد التأجير.%0Aشكراً لك.`;
            window.open(`https://wa.me/${phoneW}?text=${msg}`, '_blank');
        };

        window.downloadPDF = () => {
            document.getElementById('report-date').textContent = "تاريخ التقرير: " + new Date().toLocaleString('ar-OM');
            document.getElementById('report-table-body').innerHTML = bids.map((b, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${b.name}</td>
                    <td>${b.phone}</td>
                    <td style="font-weight:bold">${b.amount.toLocaleString('en-US')}</td>
                    <td>${formatFullDate(b.timestamp)}</td>
                </tr>
            `).join('');
            const el = document.getElementById('report-template');
            el.style.display = 'block';
            html2pdf().from(el).set({ 
                margin: 10, 
                filename: `تقرير_المزاد_${Date.now()}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            }).save().then(() => el.style.display = 'none');
        };

        const setAuthView = (v) => { currentAuthView = v; localStorage.setItem('auth_view_preference', v); updateUIVisibility(); };
        document.getElementById('btn-toggle-auction').onclick = async () => { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'auction'), { isActive: !auctionSettings.isActive }, { merge: true }); };
        document.getElementById('tab-bids').onclick = () => { adminTab = 'tab-bids'; renderAdminPanel(); };
        document.getElementById('tab-users').onclick = () => { adminTab = 'tab-users'; renderAdminPanel(); };
        document.getElementById('tab-settings').onclick = () => { adminTab = 'tab-settings'; renderAdminPanel(); };
        document.getElementById('tab-add-manual').onclick = () => { adminTab = 'tab-add-manual'; renderAdminPanel(); };

    </script>
</body>
</html>