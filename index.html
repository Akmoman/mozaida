<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>موقع مزاد أوقاف المساجد - جلبة الشيع</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Custom Scrollbar for Admin Panel */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f5f5f4; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d6d3d1; 
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a29e; 
        }
    </style>
</head>
<body class="min-h-screen bg-stone-100 font-sans text-stone-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-green-50 z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-700"></div>
    </div>

    <!-- Header -->
    <header class="bg-emerald-800 text-white p-4 shadow-md sticky top-0 z-40">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="ph ph-gavel text-2xl"></i>
                <h1 class="text-xl font-bold">لجنة أوقاف المساجد - بلدة منال</h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="user-info-badge" class="hidden items-center gap-2 text-sm bg-emerald-900/50 pl-1 pr-3 py-1 rounded-full">
                    <i class="ph ph-user text-base"></i>
                    <span id="header-user-name"></span>
                    <span id="header-admin-badge" class="hidden bg-amber-500 text-black px-2 py-0.5 rounded text-xs mr-2 font-bold">إدارة</span>
                    <button id="btn-user-logout" class="mr-3 text-emerald-200 hover:text-white flex items-center gap-1 bg-emerald-900/40 px-2 py-1 rounded-lg transition-colors" title="تسجيل الخروج">
                        <i class="ph ph-sign-out text-base"></i> خروج
                    </button>
                </div>
                <button id="btn-show-admin-login" class="p-1.5 bg-emerald-700 hover:bg-emerald-600 rounded-full transition-colors text-emerald-100 hover:text-white hidden" title="دخول الإدارة">
                    <i class="ph ph-lock text-base"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 py-8 space-y-6">
        
        <!-- Admin Controls (Hidden by default) -->
        <div id="admin-dashboard" class="hidden bg-stone-800 text-white rounded-xl shadow-lg overflow-hidden border border-stone-700">
            <div class="p-4 border-b border-stone-700 flex justify-between items-center bg-stone-900">
                <h2 class="font-bold flex items-center gap-2"><i class="ph ph-gear text-xl"></i> لوحة تحكم الإدارة</h2>
                <div class="flex gap-2">
                    <button id="btn-exit-admin" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-colors bg-stone-700 hover:bg-stone-600 text-white flex items-center gap-1">
                        <i class="ph ph-house text-base"></i> الرئيسية
                    </button>
                    <button id="btn-toggle-auction" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-colors bg-red-500 hover:bg-red-600 text-white">
                        إغلاق المزاد
                    </button>
                </div>
            </div>
            <div class="flex bg-stone-800">
                <button id="tab-bids" class="flex-1 p-3 font-semibold transition-colors bg-stone-700 text-emerald-400">
                    سجل المزايدات
                </button>
                <button id="tab-users" class="flex-1 p-3 font-semibold transition-colors hover:bg-stone-700">
                    إدارة الأعضاء (<span id="pending-users-count">0</span> بانتظار التفعيل)
                </button>
            </div>
            
            <div class="p-4 bg-stone-50 max-h-96 overflow-y-auto text-stone-800 custom-scrollbar">
                <!-- Admin Bids List -->
                <div id="admin-bids-list" class="space-y-3"></div>
                <!-- Admin Users List -->
                <div id="admin-users-list" class="space-y-3 hidden"></div>
            </div>
        </div>

        <!-- Farm Info Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden">
            <div class="bg-emerald-50 border-b border-emerald-100 p-6 text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="ph ph-leaf text-9xl"></i></div>
                <h2 class="text-3xl font-extrabold text-emerald-900 mb-2 relative z-10">إعلان تأجير مزرعة (أوقاف المساجد)</h2>
                <div class="inline-block bg-emerald-600 text-white px-6 py-1.5 rounded-full font-bold text-lg shadow-sm relative z-10">
                    اسم الوقف: جلبة الشيع
                </div>
            </div>
            
            <!-- Farm Advertisement Image -->
            <div class="w-full border-b border-stone-100 bg-stone-50 flex justify-center p-4">
                <img 
                    src="https://storage.googleapis.com/akm1983/%D8%A7%D9%95%D8%B9%D9%84%D8%A7%D9%86%20%D8%AA%D8%A7%D9%94%D8%AC%D9%8A%D8%B1%20%D9%85%D8%B2%D8%B1%D8%B9%D8%A9%20(%D8%A7%D9%94%D9%88%D9%82%D8%A7%D9%81%20%D8%A7%D9%84%D9%85%D8%B3%D8%A7%D8%AC%D8%AF).png" 
                    alt="إعلان المزرعة" 
                    class="max-h-[400px] w-auto object-contain rounded-xl shadow-sm border border-stone-200"
                    onerror="this.style.display='none';"
                />
            </div>

            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-bold border-b-2 border-emerald-500 pb-2 mb-4 inline-block">تفاصيل المزرعة</h3>
                    <ul class="space-y-3">
                        <li class="flex items-center gap-3"><i class="ph ph-map-pin text-emerald-600 text-xl"></i><span class="font-semibold text-stone-600">المكان:</span> بلدة منال</li>
                        <li class="flex items-center gap-3"><i class="ph ph-clock text-emerald-600 text-xl"></i><span class="font-semibold text-stone-600">ساعات الماء:</span> ساعتين</li>
                        <li class="flex items-center gap-3"><i class="ph ph-tree-palm text-emerald-600 text-xl"></i><span class="font-semibold text-stone-600">عدد النخيل:</span> 12 نخلة</li>
                        <li class="flex items-center gap-3"><i class="ph ph-calendar text-emerald-600 text-xl"></i><span class="font-semibold text-stone-600">مدة العقد:</span> 10 سنوات</li>
                        <li class="flex items-center gap-3"><i class="ph ph-gavel text-emerald-600 text-xl"></i><span class="font-semibold text-stone-600">نظام التأجير:</span> المزايدة الإلكترونية</li>
                    </ul>
                </div>
                
                <div class="bg-stone-50 p-4 rounded-xl border border-stone-100">
                    <h3 class="font-bold text-lg mb-3 text-stone-800">حدود الوقف:</h3>
                    <ul class="space-y-2 text-sm">
                        <li class="flex items-start gap-2"><span class="text-emerald-500 mt-1">●</span> <strong>من الشمال:</strong> طريق</li>
                        <li class="flex items-start gap-2"><span class="text-emerald-500 mt-1">●</span> <strong>من الجنوب:</strong> مزرعة أحمد بن عبدالله وأحمد بن يحيى</li>
                        <li class="flex items-start gap-2"><span class="text-emerald-500 mt-1">●</span> <strong>من الشرق:</strong> طريق</li>
                        <li class="flex items-start gap-2"><span class="text-emerald-500 mt-1">●</span> <strong>من الغرب:</strong> مبنى أولاد جابر</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Bidding Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden">
            <div class="p-6 bg-stone-50 flex flex-col items-center justify-center border-b border-stone-200">
                <p class="text-stone-500 font-semibold mb-1">أعلى سعر وصل له المزاد</p>
                <div class="text-5xl font-extrabold text-emerald-700 flex items-baseline gap-2">
                    <span id="highest-bid-display">0</span> <span class="text-2xl text-stone-400 font-medium">ريال</span>
                </div>
                <div id="auction-closed-msg" class="hidden mt-3 bg-red-100 text-red-700 px-4 py-1 rounded-full font-bold flex items-center gap-2">
                    <i class="ph ph-x-circle text-xl"></i> تم إغلاق المزاد وتمت الترسية
                </div>
            </div>

            <!-- Dynamic Action Area -->
            <div class="p-6 border-b border-stone-100">

                <!-- State 0: Login Form (New) -->
                <div id="section-login" class="max-w-md mx-auto hidden">
                    <div class="text-center mb-6">
                        <i class="ph ph-sign-in text-4xl text-emerald-600 mx-auto mb-2 block"></i>
                        <h2 class="text-xl font-bold text-stone-800">تسجيل الدخول للمزاد</h2>
                        <p class="text-stone-500 text-sm mt-1">أدخل رقم الهاتف والرقم السري الممنوح لك من الإدارة</p>
                    </div>
                    
                    <form id="form-login" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">رقم الهاتف</label>
                            <input type="tel" id="login-phone" required class="w-full border border-stone-300 rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="مثال: 9xxxxxxx" dir="ltr" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">الرقم السري</label>
                            <input type="password" id="login-password" required class="w-full border border-stone-300 rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="••••" dir="ltr" />
                        </div>
                        <p id="login-error" class="text-red-500 text-sm flex items-center gap-1 hidden bg-red-50 p-3 rounded-lg border border-red-200"><i class="ph ph-warning-circle text-lg"></i> <span></span></p>
                        <button type="submit" class="w-full bg-stone-800 hover:bg-stone-900 text-white font-bold py-3 rounded-lg transition-colors">
                            دخول للمزايدة
                        </button>
                    </form>
                    <button type="button" id="btn-show-register" class="w-full mt-4 text-base font-bold text-emerald-800 hover:text-emerald-900 transition-colors bg-emerald-100 hover:bg-emerald-200 py-3 rounded-lg">
                        ليس لديك حساب؟ الحصول على العضوية
                    </button>
                </div>
                
                <!-- State 1: Register Form -->
                <div id="section-register" class="max-w-md mx-auto hidden">
                    <div class="text-center mb-6">
                        <i class="ph ph-shield-check text-4xl text-emerald-600 mx-auto mb-2 block"></i>
                        <h2 class="text-xl font-bold text-stone-800">طلب فتح عضوية</h2>
                        <p class="text-stone-500 text-sm mt-1">قم بتعبئة بياناتك لفتح حساب للمزايدة</p>
                    </div>
                    
                    <form id="form-register" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-1">الاسم الثلاثي</label>
                            <input type="text" id="reg-name" required class="w-full border border-stone-300 rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="أدخل اسمك الكريم" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">رقم الهاتف</label>
                            <input type="tel" id="reg-phone" required class="w-full border border-stone-300 rounded-lg p-3 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="مثال: 9xxxxxxx" dir="ltr" />
                        </div>
                        <p id="reg-error" class="text-red-500 text-sm flex items-center gap-1 hidden bg-red-50 p-3 rounded-lg border border-red-200"><i class="ph ph-warning-circle text-lg"></i> <span></span></p>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg transition-colors">
                            إرسال الطلب للإدارة
                        </button>
                    </form>
                    <button type="button" id="btn-show-login" class="w-full mt-4 text-base font-bold text-stone-700 hover:text-stone-900 transition-colors bg-stone-200 hover:bg-stone-300 py-3 rounded-lg">
                        لديك عضوية ورقم سري؟ تسجيل الدخول
                    </button>
                </div>

                <!-- State 2: Pending Approval (New Clean Minimal Look) -->
                <div id="section-pending" class="hidden">
                    <div class="bg-emerald-50 p-6 rounded-xl border border-emerald-200 text-center max-w-md mx-auto shadow-sm">
                        <i class="ph ph-check-circle text-5xl text-emerald-500 mx-auto mb-3 block"></i>
                        <h3 class="text-xl font-bold text-emerald-800 mb-2">تم استلام طلبك بنجاح</h3>
                        <p class="text-emerald-700 text-sm mb-4">
                            حسابك الآن قيد المراجعة. بعد قبول طلبك، ستقوم الإدارة بتزويدك برقم سري لتتمكن من الدخول للمزايدة.
                        </p>
                        <div class="flex flex-col gap-3 mt-4 pt-4 border-t border-emerald-200/50">
                            <button type="button" id="btn-pending-to-login" class="text-sm font-semibold text-emerald-700 hover:text-emerald-900 transition-colors underline">
                                شاشة دخول الأعضاء المسجلين
                            </button>
                            <button id="btn-cancel-reg" class="text-xs font-semibold text-stone-500 hover:text-stone-800 transition-colors underline">
                                تسجيل عضو جديد
                            </button>
                        </div>
                    </div>
                </div>

                <!-- State 3: Active Bidding -->
                <div id="section-bidding" class="hidden">
                    <form id="form-bid" class="max-w-md mx-auto relative">
                        <p id="bid-error" class="text-red-500 text-sm mb-2 text-center hidden"></p>
                        <div class="flex flex-col gap-4">
                            <div class="flex items-center justify-between bg-white rounded-xl border-2 border-stone-300 overflow-hidden">
                                <button type="button" id="btn-increase-bid" class="bg-stone-100 hover:bg-stone-200 text-stone-700 p-4 text-3xl font-bold transition-colors w-16 flex justify-center items-center">
                                    +
                                </button>
                                <div class="text-3xl font-bold text-emerald-800 flex-1 text-center">
                                    <span id="current-bid-input-display">5</span> <span class="text-lg text-stone-500 font-medium">ريال</span>
                                </div>
                                <button type="button" id="btn-decrease-bid" class="bg-stone-100 hover:bg-stone-200 text-stone-700 p-4 text-3xl font-bold transition-colors w-16 flex justify-center items-center">
                                    -
                                </button>
                            </div>
                            <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-md transition-transform active:scale-95 text-lg">
                                تأكيد المزايدة بـ (<span id="btn-submit-bid-amount">5</span> ريال)
                            </button>
                        </div>
                    </form>
                </div>

            </div>

            <!-- Bids List (Public view - Anonymous) -->
            <div class="p-6">
                <h3 class="font-bold text-stone-700 mb-4 flex items-center gap-2">
                    <i class="ph ph-clock text-xl"></i> أحدث المزايدات
                </h3>
                <div id="public-bids-list" class="space-y-2">
                    <!-- Dynamic Bids go here -->
                </div>
            </div>

        </div>

    </main>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-black/50 items-center justify-center z-50 p-4 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm overflow-hidden">
            <div class="bg-stone-800 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold flex items-center gap-2"><i class="ph ph-lock text-xl"></i> دخول الإدارة</h3>
                <button id="btn-close-admin-modal" class="text-stone-400 hover:text-white">
                    <i class="ph ph-x-circle text-xl"></i>
                </button>
            </div>
            <form id="form-admin-login" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-1 text-stone-700">الرقم السري</label>
                    <input type="password" id="admin-password" class="w-full border-2 border-stone-200 rounded-lg p-3 focus:ring-0 focus:border-stone-800 outline-none text-center text-lg tracking-widest" placeholder="•••••••" dir="ltr" />
                </div>
                <p id="admin-login-error" class="text-red-500 text-sm text-center hidden"></p>
                <button type="submit" class="w-full bg-stone-800 hover:bg-stone-900 text-white font-bold py-3 rounded-lg transition-colors">
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>

    <!-- Application Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, updateDoc, serverTimestamp, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAffSkbM4yXDON0ASVwRCr165_Gu_yGPF4",
            authDomain: "aldhahir-stadium.firebaseapp.com",
            projectId: "aldhahir-stadium",
            storageBucket: "aldhahir-stadium.firebasestorage.app",
            messagingSenderId: "561631723946",
            appId: "1:561631723946:web:d17f9e8a95ed860b856bd3",
            measurementId: "G-MC7EQL2GKQ"
        };
        const appId = "aldhahir-stadium";
        
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State Variables
        let currentUser = null;
        let appProfile = null;
        let bids = [];
        let users = [];
        let auctionSettings = { isActive: true };
        let currentBidAmount = 5;
        let adminTab = 'bids'; // 'bids' or 'users'
        let currentAuthView = 'login'; // اجعل شاشة الدخول هي الافتراضية بدلاً من التسجيل

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const sectionRegister = document.getElementById('section-register');
        const sectionLogin = document.getElementById('section-login');
        const sectionPending = document.getElementById('section-pending');
        const sectionBidding = document.getElementById('section-bidding');
        const userInfoBadge = document.getElementById('user-info-badge');
        const headerUserName = document.getElementById('header-user-name');
        const headerAdminBadge = document.getElementById('header-admin-badge');
        const btnShowAdminLogin = document.getElementById('btn-show-admin-login');
        const adminDashboard = document.getElementById('admin-dashboard');
        
        // Initialization
        const initAuth = async () => {
            let localGuestUid = localStorage.getItem('guest_auction_uid');
            if (localGuestUid) {
                currentUser = { uid: localGuestUid };
                setupListeners(currentUser.uid);
                // Call anonymous auth in background just to have a valid token if needed
                try { await signInAnonymously(auth); } catch(e) {}
                return;
            }

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.warn("Auth Error caught. Falling back to temporary local user...", error);
                localGuestUid = 'guest-user-' + Math.floor(Math.random() * 1000000000);
                localStorage.setItem('guest_auction_uid', localGuestUid);
                currentUser = { uid: localGuestUid };
                setupListeners(currentUser.uid);
            }
        };

        // Auth Listener - strictly prioritize local guest ID if we have custom login system
        let localGuestUidForListener = localStorage.getItem('guest_auction_uid');
        onAuthStateChanged(auth, (user) => {
            if (localGuestUidForListener) {
                currentUser = { uid: localGuestUidForListener };
                setupListeners(currentUser.uid);
            } else if (user) {
                currentUser = user;
                setupListeners(user.uid);
            } else if (!currentUser) {
                loadingOverlay.classList.add('hidden');
                updateUIVisibility();
            }
        });

        initAuth();

        // Listeners
        let unsubProfile, unsubBids, unsubSettings, unsubUsers;

        function setupListeners(uid) {
            // Profile Listener
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
            unsubProfile = onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    appProfile = docSnap.data();
                } else {
                    appProfile = null;
                }
                
                // If admin, start listening to users if not already
                if (appProfile?.isAdmin && !unsubUsers) {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                    unsubUsers = onSnapshot(usersRef, (snap) => {
                        users = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        renderAdminPanel();
                    });
                } else if (!appProfile?.isAdmin && unsubUsers) {
                    unsubUsers();
                    unsubUsers = null;
                    users = [];
                }

                updateUIVisibility();
                loadingOverlay.classList.add('hidden');
            }, (error) => {
                console.error("Firestore Permission Error: Make sure your Firestore rules allow read/write.", error);
                loadingOverlay.classList.add('hidden');
            });

            // Bids Listener
            const bidsRef = collection(db, 'artifacts', appId, 'public', 'data', 'bids');
            unsubBids = onSnapshot(bidsRef, (snap) => {
                bids = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                bids.sort((a, b) => b.amount - a.amount);
                
                // Sync bid amount
                const highestBid = bids.length > 0 ? bids[0].amount : 0;
                if (currentBidAmount < highestBid + 5) {
                    currentBidAmount = highestBid + 5;
                } else if (bids.length === 0) {
                    currentBidAmount = 5; // إعادة ضبط المبلغ عند تصفير المزاد
                }
                
                renderBids();
                updateBidUI();
                renderAdminPanel();
            });

            // Settings Listener
            const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'auction');
            unsubSettings = onSnapshot(settingsRef, (snap) => {
                if (snap.exists()) {
                    auctionSettings = snap.data();
                } else {
                    auctionSettings = { isActive: true };
                }
                updateUIVisibility();
                renderAdminPanel();
            });
        }

        // --- Core UI Updates ---

        function updateUIVisibility() {
            // Header Info - Strictly hidden unless ACTIVE and APPROVED
            if (appProfile && appProfile.isActive === true) {
                userInfoBadge.classList.remove('hidden');
                userInfoBadge.classList.add('flex');
                headerUserName.textContent = appProfile.name;
                
                if (appProfile.isAdmin) {
                    headerAdminBadge.classList.remove('hidden');
                    btnShowAdminLogin.classList.add('hidden');
                } else {
                    headerAdminBadge.classList.add('hidden');
                    btnShowAdminLogin.classList.remove('hidden');
                }
            } else {
                userInfoBadge.classList.add('hidden');
                userInfoBadge.classList.remove('flex');
                btnShowAdminLogin.classList.remove('hidden');
            }

            // Action Area
            sectionRegister.classList.add('hidden');
            sectionLogin.classList.add('hidden');
            sectionPending.classList.add('hidden');
            sectionBidding.classList.add('hidden');
            document.getElementById('auction-closed-msg').classList.add('hidden');

            if (!auctionSettings.isActive) {
                document.getElementById('auction-closed-msg').classList.remove('hidden');
            } else {
                // الشروط الصارمة لإظهار الواجهة
                if (!appProfile) {
                    // زائر جديد تماماً
                    if (currentAuthView === 'login') {
                        sectionLogin.classList.remove('hidden');
                    } else {
                        sectionRegister.classList.remove('hidden');
                    }
                } else if (appProfile.isActive === true) {
                    // عضو مفعل ومقبول حصراً من الإدارة
                    sectionBidding.classList.remove('hidden');
                } else {
                    // مسجل ولم تقبله الإدارة بعد
                    if (currentAuthView === 'login') {
                        sectionLogin.classList.remove('hidden');
                    } else {
                        sectionPending.classList.remove('hidden');
                    }
                }
            }

            // Admin Dashboard
            if (appProfile?.isAdmin) {
                adminDashboard.classList.remove('hidden');
            } else {
                adminDashboard.classList.add('hidden');
            }
        }

        function renderBids() {
            const highestBid = bids.length > 0 ? bids[0].amount : 0;
            document.getElementById('highest-bid-display').textContent = highestBid;
            
            const publicBidsList = document.getElementById('public-bids-list');
            publicBidsList.innerHTML = '';

            if (bids.length === 0) {
                publicBidsList.innerHTML = `<p class="text-stone-400 text-center py-4 bg-stone-50 rounded-lg">لم يتم تقديم أي مزايدات حتى الآن. كن أول المزايدين!</p>`;
                return;
            }

            const recentBids = bids.slice(0, 5);
            recentBids.forEach((bid, idx) => {
                const isHighest = idx === 0;
                const isMe = currentUser && bid.userId === currentUser.uid;
                
                const wrapperClass = isHighest ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-stone-100';
                const iconBgClass = isHighest ? 'bg-emerald-200 text-emerald-800' : 'bg-stone-100 text-stone-500';
                const iconHtml = isHighest ? '<i class="ph ph-trophy text-xl"></i>' : '<i class="ph ph-user text-xl"></i>';
                const nameText = isMe ? 'أنت (مزايدتك)' : 'مزايد مخفي';
                const nameColorClass = isHighest ? 'text-emerald-800' : 'text-stone-600';
                const amountColorClass = isHighest ? 'text-emerald-700' : 'text-stone-800';

                publicBidsList.innerHTML += `
                    <div class="flex justify-between items-center p-4 rounded-xl border ${wrapperClass}">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-full flex items-center justify-center ${iconBgClass}">
                                ${iconHtml}
                            </div>
                            <span class="font-semibold ${nameColorClass}">${nameText}</span>
                        </div>
                        <span class="text-xl font-bold ${amountColorClass}">${bid.amount} ريال</span>
                    </div>
                `;
            });

            if (bids.length > 5) {
                publicBidsList.innerHTML += `<p class="text-center text-sm text-stone-400 mt-4">يتم عرض أحدث 5 مزايدات فقط</p>`;
            }
        }

        function updateBidUI() {
            document.getElementById('current-bid-input-display').textContent = currentBidAmount;
            document.getElementById('btn-submit-bid-amount').textContent = currentBidAmount;

            const highestBid = bids.length > 0 ? bids[0].amount : 0;
            const decreaseBtn = document.getElementById('btn-decrease-bid');
            
            if (currentBidAmount <= highestBid + 5) {
                decreaseBtn.classList.replace('bg-stone-100', 'bg-stone-50');
                decreaseBtn.classList.replace('hover:bg-stone-200', 'bg-stone-50');
                decreaseBtn.classList.replace('text-stone-700', 'text-stone-300');
                decreaseBtn.classList.add('cursor-not-allowed');
                decreaseBtn.disabled = true;
            } else {
                decreaseBtn.classList.replace('bg-stone-50', 'bg-stone-100');
                decreaseBtn.classList.replace('text-stone-300', 'text-stone-700');
                decreaseBtn.classList.remove('cursor-not-allowed');
                decreaseBtn.disabled = false;
            }
        }

        function renderAdminPanel() {
            if (!appProfile?.isAdmin) return;

            // Update Toggle Button Text
            const btnToggleAuction = document.getElementById('btn-toggle-auction');
            if (auctionSettings.isActive) {
                btnToggleAuction.innerHTML = '<i class="ph ph-lock-key"></i> إغلاق المزاد';
                btnToggleAuction.className = 'px-4 py-1.5 rounded-lg text-sm font-bold transition-colors bg-red-500 hover:bg-red-600 text-white flex items-center gap-1 shadow-sm border border-red-600';
            } else {
                btnToggleAuction.innerHTML = '<i class="ph ph-lock-key-open"></i> فتح المزاد';
                btnToggleAuction.className = 'px-4 py-1.5 rounded-lg text-sm font-bold transition-colors bg-green-500 hover:bg-green-600 text-white flex items-center gap-1 shadow-sm border border-green-600';
            }

            // Update Tabs
            const tabBids = document.getElementById('tab-bids');
            const tabUsers = document.getElementById('tab-users');
            const listBids = document.getElementById('admin-bids-list');
            const listUsers = document.getElementById('admin-users-list');

            // إخفاء المدراء من القائمة لحل مشكلة تكرار الإدارة
            const normalUsers = users.filter(u => !u.isAdmin);
            const pendingCount = normalUsers.filter(u => !u.isActive).length;
            document.getElementById('pending-users-count').textContent = pendingCount;

            if (adminTab === 'bids') {
                tabBids.classList.add('bg-stone-700', 'text-emerald-400');
                tabUsers.classList.remove('bg-stone-700', 'text-emerald-400');
                listBids.classList.remove('hidden');
                listUsers.classList.add('hidden');

                // Render Bids
                listBids.innerHTML = '';
                
                if (bids.length > 0) {
                    listBids.innerHTML += `
                        <div class="flex justify-end mb-3">
                            <button onclick="window.handleClearAllBids()" class="px-3 py-1.5 rounded-lg text-sm font-bold bg-red-100 text-red-700 hover:bg-red-200 transition-colors flex items-center gap-1 shadow-sm border border-red-200">
                                <i class="ph ph-trash"></i> تصفير جميع المزايدات
                            </button>
                        </div>
                    `;
                }

                if (bids.length === 0) {
                    listBids.innerHTML = `<p class="text-center text-stone-500 py-4">لا توجد مزايدات حتى الآن.</p>`;
                } else {
                    bids.forEach((bid, idx) => {
                        const wrapperClass = idx === 0 ? 'bg-green-100 border-green-300' : 'bg-white border-stone-200 mb-2';
                        const trophyIcon = idx === 0 ? '<i class="ph ph-trophy text-xl text-amber-500"></i>' : '';
                        listBids.innerHTML += `
                            <div class="flex justify-between items-center p-3 rounded-lg border ${wrapperClass}">
                                <div>
                                    <div class="font-bold text-lg flex items-center gap-2">
                                        ${trophyIcon} ${bid.name}
                                    </div>
                                    <div class="text-sm text-stone-500 dir-ltr text-right">${bid.phone}</div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-xl font-bold text-emerald-700">${bid.amount} ريال</div>
                                    <button onclick="window.handleDeleteBid('${bid.id}')" class="text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition-colors border border-red-100" title="حذف المزايدة">
                                        <i class="ph ph-trash text-lg"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
            } else {
                tabUsers.classList.add('bg-stone-700', 'text-emerald-400');
                tabBids.classList.remove('bg-stone-700', 'text-emerald-400');
                listUsers.classList.remove('hidden');
                listBids.classList.add('hidden');

                // Render Users
                listUsers.innerHTML = '';
                if (normalUsers.length === 0) {
                    listUsers.innerHTML = `<p class="text-center text-stone-500 py-4">لا يوجد أعضاء مسجلين.</p>`;
                }
                
                normalUsers.forEach(u => {
                    const pendingBadge = !u.isActive ? '<div class="text-xs text-amber-600 mt-1 font-semibold">بانتظار الإجراء</div>' : '';
                    const pwdBadge = u.password ? `<div class="text-sm text-blue-600 mt-1 font-bold flex items-center gap-1"><i class="ph ph-key"></i> الرقم السري: ${u.password}</div>` : '';
                    
                    let actionButtons = '';
                    if (!u.isActive) {
                        actionButtons = `
                            <button onclick="window.toggleUserActivation('${u.id}', ${u.isActive})" class="px-3 py-1 rounded text-sm font-bold bg-green-100 text-green-700 hover:bg-green-200 transition-colors">قبول وتعيين رقم سري</button>
                            <button onclick="window.handleDeleteUser('${u.id}')" class="px-3 py-1 rounded text-sm font-bold bg-red-100 text-red-700 hover:bg-red-200 transition-colors">رفض</button>
                        `;
                    } else {
                        actionButtons = `
                            <button onclick="window.toggleUserActivation('${u.id}', ${u.isActive})" class="px-3 py-1 rounded text-sm font-bold bg-amber-100 text-amber-700 hover:bg-amber-200 transition-colors">حظر</button>
                        `;
                    }

                    listUsers.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-white rounded-lg border border-stone-200">
                            <div>
                                <div class="font-bold flex items-center">${u.name}</div>
                                <div class="text-sm text-stone-500 dir-ltr text-right">${u.phone}</div>
                                ${pwdBadge}
                                ${pendingBadge}
                            </div>
                            <div class="flex gap-2">
                                ${actionButtons}
                            </div>
                        </div>
                    `;
                });
            }
        }

        // --- Event Listeners & Actions ---

        // Toggle Auth View (Login vs Register)
        document.getElementById('btn-show-login').addEventListener('click', () => {
            currentAuthView = 'login';
            updateUIVisibility();
        });
        document.getElementById('btn-show-register').addEventListener('click', () => {
            currentAuthView = 'register';
            updateUIVisibility();
        });
        document.getElementById('btn-pending-to-login').addEventListener('click', () => {
            currentAuthView = 'login';
            updateUIVisibility();
        });

        // Registration
        document.getElementById('form-register').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const errorEl = document.getElementById('reg-error');

            if (!name || !phone) {
                errorEl.querySelector('span').textContent = 'يرجى تعبئة جميع الحقول';
                errorEl.classList.remove('hidden');
                return;
            }
            errorEl.classList.add('hidden');

            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), {
                    uid: currentUser.uid,
                    name: name,
                    phone: phone,
                    isActive: false, 
                    isAdmin: false,
                    registeredAt: serverTimestamp()
                });
            } catch (err) {
                errorEl.querySelector('span').textContent = 'خطأ: ' + err.message;
                errorEl.classList.remove('hidden');
                console.error(err);
            }
        });

        // Custom Login Form Logic
        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('login-phone').value;
            const pass = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            try {
                // جلب قائمة الأعضاء للبحث عن التطابق (طريقة آمنة لتجنب مشاكل الفهرسة في Firebase)
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                const snapshot = await getDocs(usersRef);
                let foundUser = null;

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (data.phone === phone && data.password === pass) {
                        foundUser = data;
                    }
                });

                if (foundUser) {
                    if (!foundUser.isActive && !foundUser.isAdmin) {
                        errorEl.querySelector('span').textContent = 'حسابك محظور من قبل الإدارة.';
                        errorEl.classList.remove('hidden');
                        return;
                    }
                    
                    // تم تسجيل الدخول بنجاح!
                    localStorage.setItem('guest_auction_uid', foundUser.uid);
                    window.location.reload(); // إعادة تحميل الصفحة لتطبيق الحساب
                } else {
                    errorEl.querySelector('span').textContent = 'رقم الهاتف أو الرقم السري غير صحيح.';
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                errorEl.querySelector('span').textContent = 'حدث خطأ في الاتصال بقاعدة البيانات.';
                errorEl.classList.remove('hidden');
                console.error(err);
            }
        });

        // User Logout
        document.getElementById('btn-user-logout').addEventListener('click', async () => {
            localStorage.removeItem('guest_auction_uid');
            try { await auth.signOut(); } catch(e) {}
            window.location.reload();
        });

        // Cancel Registration (And WIPE Session to test as fresh user)
        document.getElementById('btn-cancel-reg').addEventListener('click', async () => {
            if (!currentUser) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid));
                localStorage.removeItem('guest_auction_uid');
                window.location.reload(); 
            } catch (err) {
                console.error(err);
            }
        });

        // Bidding Actions (+ / - / Submit)
        document.getElementById('btn-increase-bid').addEventListener('click', () => {
            currentBidAmount += 5;
            updateBidUI();
        });

        document.getElementById('btn-decrease-bid').addEventListener('click', () => {
            const highestBid = bids.length > 0 ? bids[0].amount : 0;
            if (currentBidAmount > highestBid + 5) {
                currentBidAmount -= 5;
                updateBidUI();
            }
        });

        document.getElementById('form-bid').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorEl = document.getElementById('bid-error');
            const highestBid = bids.length > 0 ? bids[0].amount : 0;

            if (!appProfile || appProfile.isActive !== true) {
                errorEl.textContent = `عذراً، حسابك قيد المراجعة ولا تملك صلاحية المزايدة.`;
                errorEl.classList.remove('hidden');
                return;
            }

            if (isNaN(currentBidAmount) || currentBidAmount < highestBid + 5 || currentBidAmount % 5 !== 0) {
                errorEl.textContent = `يجب أن يكون المبلغ من مضاعفات الـ 5 وأعلى من المزايدة الحالية`;
                errorEl.classList.remove('hidden');
                return;
            }
            errorEl.classList.add('hidden');

            try {
                const bidsRef = collection(db, 'artifacts', appId, 'public', 'data', 'bids');
                await addDoc(bidsRef, {
                    amount: currentBidAmount,
                    userId: currentUser.uid,
                    name: appProfile.name,
                    phone: appProfile.phone,
                    timestamp: serverTimestamp()
                });
            } catch (err) {
                errorEl.textContent = 'حدث خطأ أثناء تقديم المزايدة.';
                errorEl.classList.remove('hidden');
            }
        });

        // Admin Login Modal Toggles
        const adminModal = document.getElementById('admin-login-modal');
        btnShowAdminLogin.addEventListener('click', () => {
            adminModal.classList.remove('hidden');
            adminModal.classList.add('flex');
        });
        document.getElementById('btn-close-admin-modal').addEventListener('click', () => {
            adminModal.classList.add('hidden');
            adminModal.classList.remove('flex');
            document.getElementById('admin-login-error').classList.add('hidden');
            document.getElementById('admin-password').value = '';
        });

        // Admin Login Form
        document.getElementById('form-admin-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pass = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-login-error');

            if (pass === 'akm1983') {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid), {
                        uid: currentUser.uid,
                        name: appProfile?.name || 'akm1983',
                        phone: appProfile?.phone || '-',
                        isActive: true, // الإدارة دائماً فعالة
                        isAdmin: true,
                        registeredAt: serverTimestamp()
                    }, { merge: true });
                    
                    adminModal.classList.add('hidden');
                    adminModal.classList.remove('flex');
                    document.getElementById('admin-password').value = '';
                    errorEl.classList.add('hidden');
                } catch (err) {
                    errorEl.textContent = 'حدث خطأ في النظام.';
                    errorEl.classList.remove('hidden');
                }
            } else {
                errorEl.textContent = 'الرقم السري غير صحيح';
                errorEl.classList.remove('hidden');
            }
        });

        // Admin Dashboard Controls
        document.getElementById('tab-bids').addEventListener('click', () => {
            adminTab = 'bids';
            renderAdminPanel();
        });
        
        document.getElementById('tab-users').addEventListener('click', () => {
            adminTab = 'users';
            renderAdminPanel();
        });

        document.getElementById('btn-toggle-auction').addEventListener('click', async () => {
            try {
                const newState = !auctionSettings.isActive;
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'auction');
                await setDoc(settingsRef, { isActive: newState }, { merge: true });
            } catch (err) {
                console.error("Error toggling auction status:", err);
                alert("حدث خطأ أثناء محاولة تغيير حالة المزاد. يرجى التأكد من صلاحيات قاعدة البيانات.");
            }
        });

        // مسح الذاكرة بالكامل عند خروج المدير لمنع التداخل
        document.getElementById('btn-exit-admin').addEventListener('click', async () => {
            if (!currentUser || !appProfile) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.uid));
                localStorage.removeItem('guest_auction_uid');
                window.location.reload();
            } catch (err) {
                console.error(err);
            }
        });

        // Expose admin functions to global window object for inline HTML onclick handlers
        window.toggleUserActivation = async (userId, currentState) => {
            try {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
                if (!currentState) { // قبول العضو وتعيين رقم سري
                    const pwd = prompt('أدخل رقماً سرياً (كلمة مرور) لتعطيه لهذا العضو ليتمكن من الدخول لاحقاً:\n(مثال: 1234)');
                    if (pwd === null) return; // تم الإلغاء
                    if (pwd.trim() === '') {
                        alert('يجب إدخال رقم سري لكي يتمكن العضو من الدخول لاحقاً!');
                        return;
                    }
                    await updateDoc(userRef, { isActive: true, password: pwd.trim() });
                } else { // حظر العضو
                    await updateDoc(userRef, { isActive: false });
                }
            } catch (err) {
                console.error(err);
            }
        };

        window.handleDeleteUser = async (userId) => {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userId));
            } catch (err) {
                console.error(err);
            }
        };

        window.handleDeleteBid = async (bidId) => {
            if(!confirm('هل أنت متأكد من حذف هذه المزايدة؟')) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bids', bidId));
            } catch (err) {
                console.error(err);
            }
        };

        window.handleClearAllBids = async () => {
            if(!confirm('هل أنت متأكد من مسح جميع المزايدات بالكامل وتصفير المزاد؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            try {
                for (const bid of bids) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bids', bid.id));
                }
            } catch (err) {
                console.error(err);
            }
        };

    </script>
</body>
</html>